import numpy as np
import json
import os
import csv
from typing import Optional, List, Dict
from enum import IntEnum
from datetime import datetime


class Departamento(IntEnum):
    DEPORTES = 0
    ROPA = 1
    JUGUETERIA = 2


class Mes(IntEnum):
    ENERO = 0
    FEBRERO = 1
    MARZO = 2
    ABRIL = 3
    MAYO = 4
    JUNIO = 5
    JULIO = 6
    AGOSTO = 7
    SEPTIEMBRE = 8
    OCTUBRE = 9
    NOVIEMBRE = 10
    DICIEMBRE = 11


class MatrizVentas:

    
    MESES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
             'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
    
    DEPARTAMENTOS = ['Deportes', 'Ropa', 'Juguetería']
    
    ARCHIVO_DATOS = 'ventas_data.json'
    
    def __init__(self):
        self.matriz = np.zeros((12, 3), dtype=np.float64)
        self.cargar_datos()
    
    def insertar_venta(self, mes: int, departamento: int, monto: float) -> bool:
        if not self._validar_indices(mes, departamento):
            print(f"\n Error: Índices inválidos (mes: {mes}, departamento: {departamento})")
            return False
        
        if monto < 0:
            print(f"\n Error: El monto no puede ser negativo ({monto})")
            return False
        
        self.matriz[mes, departamento] += monto
        print(f"\n Venta agregada: {self.MESES[mes]} - {self.DEPARTAMENTOS[departamento]}: ${monto:,.2f}")
        print(f"  Nuevo total: ${self.matriz[mes, departamento]:,.2f}")
        return True
    
    def buscar_por_mes_departamento(self, mes: int, departamento: int) -> Optional[float]:
        if not self._validar_indices(mes, departamento):
            print(f"\n Error: Índices inválidos")
            return None
        
        monto = self.matriz[mes, departamento]
        print(f"\n {self.MESES[mes]} - {self.DEPARTAMENTOS[departamento]}: ${monto:,.2f}")
        return monto
    
    def buscar_por_monto(self, monto_min: float, monto_max: float = None) -> List[Dict]:
        resultados = []
        
        if monto_max is None:
            monto_max = float('inf')
        
        for mes in range(12):
            for dept in range(3):
                monto = self.matriz[mes, dept]
                if monto_min <= monto <= monto_max and monto > 0:
                    resultados.append({
                        'mes': self.MESES[mes],
                        'mes_idx': mes,
                        'departamento': self.DEPARTAMENTOS[dept],
                        'departamento_idx': dept,
                        'monto': monto
                    })
        
        print(f"\n Encontrados {len(resultados)} resultado(s) con monto entre ${monto_min:,.2f} y ${monto_max:,.2f}")
        if resultados:
            print("-" * 60)
            for r in resultados:
                print(f"  • {r['mes']:<12} - {r['departamento']:<12}: ${r['monto']:>12,.2f}")
        return resultados
    
    def buscar_multiples_criterios(self, 
                                   meses: List[int] = None,
                                   departamentos: List[int] = None,
                                   monto_min: float = None,
                                   monto_max: float = None) -> List[Dict]:
        if meses is None:
            meses = list(range(12))
        if departamentos is None:
            departamentos = list(range(3))
        if monto_min is None:
            monto_min = 0
        if monto_max is None:
            monto_max = float('inf')
        
        resultados = []
        
        for mes in meses:
            for dept in departamentos:
                if self._validar_indices(mes, dept):
                    monto = self.matriz[mes, dept]
                    if monto_min <= monto <= monto_max and monto > 0:
                        resultados.append({
                            'mes': self.MESES[mes],
                            'mes_idx': mes,
                            'departamento': self.DEPARTAMENTOS[dept],
                            'departamento_idx': dept,
                            'monto': monto
                        })
        
        print(f"\n Búsqueda con criterios múltiples: {len(resultados)} resultado(s)")
        if resultados:
            print("-" * 60)
            for r in resultados:
                print(f"  • {r['mes']:<12} - {r['departamento']:<12}: ${r['monto']:>12,.2f}")
        return resultados
    
    def eliminar_venta(self, mes: int, departamento: int, monto: float = None) -> bool:
        if not self._validar_indices(mes, departamento):
            print(f"\n Error: Índices inválidos")
            return False
        
        valor_actual = self.matriz[mes, departamento]
        
        if monto is None:
            self.matriz[mes, departamento] = 0
            print(f"\n Venta eliminada (reseteada): {self.MESES[mes]} - {self.DEPARTAMENTOS[departamento]}")
            print(f"   Valor anterior: ${valor_actual:,.2f} → Nuevo valor: $0.00")
        else:      
            if monto < 0:
                print(f"\n Error: El monto a eliminar no puede ser negativo")
                return False
            
            if monto > valor_actual:
                print(f"\n Advertencia: El monto a eliminar (${monto:,.2f}) es mayor que el total (${valor_actual:,.2f})")
                print(f"   Se reseteará a $0.00")
                self.matriz[mes, departamento] = 0
            else:
                self.matriz[mes, departamento] -= monto
                print(f"\n Venta parcial eliminada: {self.MESES[mes]} - {self.DEPARTAMENTOS[departamento]}")
                print(f"   ${valor_actual:,.2f} - ${monto:,.2f} = ${self.matriz[mes, departamento]:,.2f}")
        
        return True
    
    def _validar_indices(self, mes: int, departamento: int) -> bool:
        return 0 <= mes < 12 and 0 <= departamento < 3
    
    def obtener_total_mes(self, mes: int) -> Optional[float]:
        if not (0 <= mes < 12):
            return None
        return np.sum(self.matriz[mes, :])
    
    def obtener_total_departamento(self, departamento: int) -> Optional[float]:
        if not (0 <= departamento < 3):
            return None
        return np.sum(self.matriz[:, departamento])
    
    def obtener_total_anual(self) -> float:
        return np.sum(self.matriz)
    
    def mostrar_matriz(self):
        print("\n" + "="*80)
        print("MATRIZ DE VENTAS MENSUALES POR DEPARTAMENTO")
        print("="*80)
        print(f"{'Mes':<15} {'Deportes':>18} {'Ropa':>18} {'Juguetería':>18} {'Total':>10}")
        print("-"*80)
        
        for i, mes in enumerate(self.MESES):
            total_mes = self.obtener_total_mes(i)
            print(f"{mes:<15} ${self.matriz[i, 0]:>16,.2f} ${self.matriz[i, 1]:>16,.2f} "
                  f"${self.matriz[i, 2]:>16,.2f} ${total_mes:>8,.2f}")
        
        print("-"*80)
        totales = [self.obtener_total_departamento(i) for i in range(3)]
        total_anual = self.obtener_total_anual()
        print(f"{'TOTAL':<15} ${totales[0]:>16,.2f} ${totales[1]:>16,.2f} "
              f"${totales[2]:>16,.2f} ${total_anual:>8,.2f}")
        print("="*80)
    
    def mostrar_estadisticas(self):
        print("\n" + "="*80)
        print(" ESTADÍSTICAS DE VENTAS")
        print("="*80)
    
        total_anual = self.obtener_total_anual()
        print(f"\n TOTAL ANUAL: ${total_anual:,.2f}")
        
        print("\n TOTALES POR DEPARTAMENTO:")
        print("-" * 50)
        for i, dept in enumerate(self.DEPARTAMENTOS):
            total = self.obtener_total_departamento(i)
            porcentaje = (total / total_anual * 100) if total_anual > 0 else 0
            print(f"  {dept:<15}: ${total:>15,.2f} ({porcentaje:>5.1f}%)")
        

        print("\n ANÁLISIS MENSUAL:")
        print("-" * 50)
        totales_meses = [self.obtener_total_mes(i) for i in range(12)]
        mes_max = np.argmax(totales_meses)
        mes_min = np.argmin([t if t > 0 else float('inf') for t in totales_meses])
        
        print(f"  Mejor mes:  {self.MESES[mes_max]:<12} - ${totales_meses[mes_max]:,.2f}")
        if totales_meses[mes_min] > 0:
            print(f"  Peor mes:   {self.MESES[mes_min]:<12} - ${totales_meses[mes_min]:,.2f}")
        

        print("\n RANKING DE DEPARTAMENTOS:")
        print("-" * 50)
        ranking = [(i, self.DEPARTAMENTOS[i], self.obtener_total_departamento(i)) 
                   for i in range(3)]
        ranking.sort(key=lambda x: x[2], reverse=True)
        
        for pos, (idx, dept, total) in enumerate(ranking, 1):
            print(f"  {pos}. {dept:<15}: ${total:,.2f}")
        
        print("="*80)
    
    def limpiar_matriz(self):
        self.matriz = np.zeros((12, 3), dtype=np.float64)
        print("\n Matriz limpiada completamente. Todos los valores han sido reseteados a $0.00")
    
    def exportar_csv(self, nombre_archivo: str = None):
        if nombre_archivo is None:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            nombre_archivo = f"ventas_export_{timestamp}.csv"
        
        try:
            with open(nombre_archivo, 'w', newline='', encoding='utf-8') as f:
                writer = csv.writer(f)                
                
                writer.writerow(['Mes', 'Deportes', 'Ropa', 'Juguetería', 'Total'])
                
                for i, mes in enumerate(self.MESES):
                    total_mes = self.obtener_total_mes(i)
                    writer.writerow([
                        mes,
                        f"{self.matriz[i, 0]:.2f}",
                        f"{self.matriz[i, 1]:.2f}",
                        f"{self.matriz[i, 2]:.2f}",
                        f"{total_mes:.2f}"
                    ])
                
                totales = [self.obtener_total_departamento(i) for i in range(3)]
                total_anual = self.obtener_total_anual()
                writer.writerow([
                    'TOTAL',
                    f"{totales[0]:.2f}",
                    f"{totales[1]:.2f}",
                    f"{totales[2]:.2f}",
                    f"{total_anual:.2f}"
                ])
            
            print(f"\n✓ Datos exportados exitosamente a: {nombre_archivo}")
            return True
        except Exception as e:
            print(f"\n Error al exportar: {e}")
            return False
    
    def guardar_datos(self):
        try:
            datos = {
                'matriz': self.matriz.tolist(),
                'fecha_guardado': datetime.now().isoformat()
            }
            with open(self.ARCHIVO_DATOS, 'w', encoding='utf-8') as f:
                json.dump(datos, f, indent=2)
            print("\n Datos guardados exitosamente")
            return True
        except Exception as e:
            print(f"\n Error al guardar datos: {e}")
            return False
    
    def cargar_datos(self):
        if os.path.exists(self.ARCHIVO_DATOS):
            try:
                with open(self.ARCHIVO_DATOS, 'r', encoding='utf-8') as f:
                    datos = json.load(f)
                self.matriz = np.array(datos['matriz'], dtype=np.float64)
                print(f" Datos cargados desde {self.ARCHIVO_DATOS}")
                return True
            except Exception as e:
                print(f" No se pudieron cargar los datos: {e}")
                print("  Iniciando con matriz vacía...")
                return False
        return False


class SistemaVentas:
    
    def __init__(self):
        self.ventas = MatrizVentas()
    
    def mostrar_menu_principal(self):
        print("\n" + "="*80)
        print(" SISTEMA DE GESTIÓN DE VENTAS POR DEPARTAMENTO")
        print("="*80)
        print("1.  Insertar venta")
        print("2.  Buscar por mes y departamento")
        print("3.  Buscar por rango de monto")
        print("4.  Buscar con múltiples criterios")
        print("5.  Eliminar venta")
        print("6.  Mostrar matriz completa")
        print("7.  Ver estadísticas")
        print("8.  Exportar a CSV")
        print("9.  Limpiar toda la matriz")
        print("10. Guardar datos")
        print("0.  Salir")
        print("="*80)
    
    def mostrar_menu_meses(self):
        print("\nSELECCIONE EL MES:")
        for i, mes in enumerate(MatrizVentas.MESES):
            print(f"{i}. {mes}")
    
    def mostrar_menu_departamentos(self):
        print("\nSELECCIONE EL DEPARTAMENTO:")
        for i, dept in enumerate(MatrizVentas.DEPARTAMENTOS):
            print(f"{i}. {dept}")
    
    def opcion_insertar(self):
        print("\n" + "="*60)
        print(" INSERTAR NUEVA VENTA")
        print("="*60)
        
        self.mostrar_menu_meses()
        try:
            mes = int(input("\nMes (0-11): "))
            
            self.mostrar_menu_departamentos()
            dept = int(input("Departamento (0-2): "))
            
            monto = float(input("Monto de la venta: $"))
            
            self.ventas.insertar_venta(mes, dept, monto)
        except ValueError:
            print("\n Error: Debe ingresar un número válido")
        except Exception as e:
            print(f"\n Error: {e}")
    
    def opcion_buscar_mes_dept(self):
        print("\n" + "="*60)
        print(" BUSCAR POR MES Y DEPARTAMENTO")
        print("="*60)
        
        self.mostrar_menu_meses()
        try:
            mes = int(input("\nMes (0-11): "))
            
            self.mostrar_menu_departamentos()
            dept = int(input("Departamento (0-2): "))
            
            self.ventas.buscar_por_mes_departamento(mes, dept)
        except ValueError:
            print("\n Error: Debe ingresar un número válido")
        except Exception as e:
            print(f"\n Error: {e}")
    
    def opcion_buscar_monto(self):
        print("\n" + "="*60)
        print(" BUSCAR POR RANGO DE MONTO")
        print("="*60)
        
        try:
            monto_min = float(input("Monto mínimo: $"))
            monto_max_input = input("Monto máximo (Enter para sin límite): $")
            monto_max = float(monto_max_input) if monto_max_input.strip() else None
            
            self.ventas.buscar_por_monto(monto_min, monto_max)
        except ValueError:
            print("\n Error: Debe ingresar un número válido")
        except Exception as e:
            print(f"\n Error: {e}")
    
    def opcion_buscar_multiples(self):
        print("\n" + "="*60)
        print(" BÚSQUEDA CON MÚLTIPLES CRITERIOS")
        print("="*60)
        
        try:
            print("\n¿Filtrar por meses específicos? (s/n): ", end="")
            if input().lower() == 's':
                print("Ingrese los números de mes separados por comas (ej: 0,1,2):")
                meses_input = input("Meses: ")
                meses = [int(m.strip()) for m in meses_input.split(',')]
            else:
                meses = None
            
            print("\n¿Filtrar por departamentos específicos? (s/n): ", end="")
            if input().lower() == 's':
                print("Ingrese los números de departamento separados por comas (ej: 0,1):")
                depts_input = input("Departamentos: ")
                departamentos = [int(d.strip()) for d in depts_input.split(',')]
            else:
                departamentos = None
            
            print("\n¿Filtrar por rango de monto? (s/n): ", end="")
            if input().lower() == 's':
                monto_min = float(input("Monto mínimo: $"))
                monto_max_input = input("Monto máximo (Enter para sin límite): $")
                monto_max = float(monto_max_input) if monto_max_input.strip() else None
            else:
                monto_min = None
                monto_max = None
            
            self.ventas.buscar_multiples_criterios(meses, departamentos, monto_min, monto_max)
        except ValueError:
            print("\n Error: Debe ingresar valores numéricos válidos")
        except Exception as e:
            print(f"\n Error: {e}")
    
    def opcion_eliminar(self):
        print("\n" + "="*60)
        print(" ELIMINAR VENTA")
        print("="*60)
        
        self.mostrar_menu_meses()
        try:
            mes = int(input("\nMes (0-11): "))
            
            self.mostrar_menu_departamentos()
            dept = int(input("Departamento (0-2): "))
            
            print("\nOpciones:")
            print("1. Resetear a $0.00 (eliminar todo)")
            print("2. Restar un monto específico")
            opcion = input("Seleccione (1 o 2): ")
            
            if opcion == "1":
                self.ventas.eliminar_venta(mes, dept)
            elif opcion == "2":
                monto = float(input("Monto a restar: $"))
                self.ventas.eliminar_venta(mes, dept, monto)
            else:
                print("\n Opción inválida")
        except ValueError:
            print("\n Error: Debe ingresar un número válido")
        except Exception as e:
            print(f"\n Error: {e}")
    
    def opcion_exportar_csv(self):
        print("\n" + "="*60)
        print(" EXPORTAR A CSV")
        print("="*60)
        
        nombre = input("\nNombre del archivo (Enter para automático): ").strip()
        if nombre and not nombre.endswith('.csv'):
            nombre += '.csv'
        
        self.ventas.exportar_csv(nombre if nombre else None)
    
    def opcion_limpiar(self):
        print("\n¿Está seguro de que desea limpiar TODA la matriz?")
        print("   Esta acción eliminará todos los datos. (s/n): ", end="")
        
        if input().lower() == 's':
            self.ventas.limpiar_matriz()
        else:
            print("\nOperación cancelada")
    
    def ejecutar(self):
        print("\n Bienvenido al Sistema de Gestión de Ventas")
        print("=" * 80)
        
        while True:
            self.mostrar_menu_principal()
            
            try:
                opcion = input("\nSeleccione una opción: ").strip()
                
                if opcion == "1":
                    self.opcion_insertar()
                elif opcion == "2":
                    self.opcion_buscar_mes_dept()
                elif opcion == "3":
                    self.opcion_buscar_monto()
                elif opcion == "4":
                    self.opcion_buscar_multiples()
                elif opcion == "5":
                    self.opcion_eliminar()
                elif opcion == "6":
                    self.ventas.mostrar_matriz()
                elif opcion == "7":
                    self.ventas.mostrar_estadisticas()
                elif opcion == "8":
                    self.opcion_exportar_csv()
                elif opcion == "9":
                    self.opcion_limpiar()
                elif opcion == "10":
                    self.ventas.guardar_datos()
                elif opcion == "0":
                    print("\n¿Desea guardar los datos antes de salir? (s/n): ", end="")
                    if input().lower() == 's':
                        self.ventas.guardar_datos()
                    print("\n ¡Hasta luego! Gracias por usar el sistema.\n")
                    break
                else:
                    print("\nOpción inválida. Por favor seleccione un número del menú.")
                
                input("\nPresione Enter para continuar...")
                
            except KeyboardInterrupt:
                print("\n\nPrograma interrumpido. ¡Hasta luego!")
                break
            except Exception as e:
                print(f"\n Error inesperado: {e}")
                input("\nPresione Enter para continuar...")




if __name__ == "__main__":
    sistema = SistemaVentas()
    sistema.ejecutar()
